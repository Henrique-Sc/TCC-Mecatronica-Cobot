<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Programação em Blocos</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #f0f0f0;
    }

    .toolbox {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: transparent;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 0 10px #aaa;
      display: flex;
      gap: 10px;
      z-index: 100;
    }

    .tool {
      width: 60px;
      height: 60px;
      background: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: grab;
      user-select: none;
    }

    .tool.square {
      background: #ff6961;
    }

    .tool.triangle {
      background: transparent;
      padding: 0;
    }

    .tool.circle {
      background: #77dd77;
      border-radius: 50%;
    }

    #workspace {
      margin: 100px auto;
      width: 90%;
      min-height: 150px;
      background: #fff;
      border: 2px dashed #aaa;
      border-radius: 10px;
      padding: 20px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .block {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      /* border: 2px solid #888; */
      border-radius: 6px;
      /* background: #f9f9f9; */
      cursor: grab;
    }

    .arrow {
      font-size: 24px;
      user-select: none;
    }

    .drag-over {
      border: 2px dashed #00f !important;
    }
  </style>
</head>
<body>

  <div id="workspace" ondragover="event.preventDefault()"></div>

  <div class="toolbox">
    <div class="tool square" draggable="true" data-shape="square"></div>
    <div class="tool triangle" draggable="true" data-shape="triangle">
      <svg width="100%" height="100%" viewBox="0 0 100 100">
        <polygon points="50,0 0,100 100,100" fill="#fdfd96"/>
      </svg>
    </div>
    <div class="tool circle" draggable="true" data-shape="circle"></div>
  </div>

  <script>
    const toolboxItems = document.querySelectorAll('.tool');
    const workspace = document.getElementById('workspace');
    let draggedBlock = null;

    toolboxItems.forEach(tool => {
      tool.addEventListener('dragstart', e => {
        draggedBlock = createBlock(tool.dataset.shape);
      });
    });

    workspace.addEventListener('dragover', e => {
      e.preventDefault();
      const afterElement = getDragAfterElement(workspace, e.clientX);

      if (draggedBlock) {
        if (!workspace.contains(draggedBlock)) {
          // Novo bloco vindo da toolbox
          if (afterElement == null) {
            workspace.appendChild(draggedBlock);
          } else {
            workspace.insertBefore(draggedBlock, afterElement);
          }
        } else {
          // Bloco sendo reordenado dentro do workspace
          const children = [...workspace.children].filter(el => el.classList.contains('block'));
          const lastBlock = children[children.length - 1];

          if (afterElement == null) {
            // Se estiver no final e não for o último já
            if (draggedBlock !== lastBlock) {
              workspace.appendChild(draggedBlock);
            }
          } else if (afterElement !== draggedBlock) {
            workspace.insertBefore(draggedBlock, afterElement);
          }
        }
        updateArrows();
      }
    });



    workspace.addEventListener('drop', () => {
      draggedBlock = null;
      updateArrows();
    });

    function createBlock(type) {
      const block = document.createElement('div');
      block.classList.add('block');
      block.setAttribute('draggable', 'true');
      block.dataset.shape = type;

      const shape = document.createElement('div');
      shape.classList.add('tool', type);
      if (type === 'triangle') {
        shape.innerHTML = `
      <svg width="100%" height="100%" viewBox="0 0 100 100">
        <polygon points="50,0 0,100 100,100" fill="#fdfd96"/>
      </svg>
        `;
      }
      block.appendChild(shape);
      

      block.addEventListener('dragstart', () => {
        block.classList.add('dragging');
        draggedBlock = block;
      });

      block.addEventListener('dragend', () => {
        block.classList.remove('dragging');
        draggedBlock = null;
        updateArrows();
      });

      return block;
    }

    function getDragAfterElement(container, x) {
      const elements = [...container.children];
      const draggableElements = elements.filter(el => el.classList.contains('block') && !el.classList.contains('dragging'));

      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }


    function updateArrows() {
      // Remove todas as setas
      const arrows = workspace.querySelectorAll('.arrow');
      arrows.forEach(arrow => arrow.remove());

      const blocks = workspace.querySelectorAll('.block');

      blocks.forEach((block, index) => {
        const next = block.nextElementSibling;
        if (index < blocks.length - 1 && (!next || !next.classList.contains('arrow'))) {
          const arrow = document.createElement('div');
          arrow.classList.add('arrow');
          arrow.textContent = '➡️';
          workspace.insertBefore(arrow, block.nextSibling);
        }
      });
    }
  </script>

</body>
</html>
